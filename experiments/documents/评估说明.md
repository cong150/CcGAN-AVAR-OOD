# ğŸ” OODæ³›åŒ–æ€§èƒ½è¯„ä¼°æŒ‡å—

## ğŸ¯ **æ ¸å¿ƒé—®é¢˜è§£ç­”**

### **Q1: è®­ç»ƒæ—¶æ²¡æœ‰45-90åº¦æ•°æ®ï¼Œæ€ä¹ˆè¯„ä¼°OODæ€§èƒ½ï¼Ÿ**

**A**: æ¡ä»¶ç”Ÿæˆæ¨¡å‹å¯ä»¥æ¥å—**ä»»æ„**æ¡ä»¶è¾“å…¥ï¼

```python
# ç†è§£æ¡ä»¶ç”Ÿæˆæ¨¡å‹
class ConditionalGAN:
    def generate(self, noise, condition):
        # conditionå¯ä»¥æ˜¯ä»»æ„å€¼ï¼
        return fake_image
        
# è®­ç»ƒæ—¶ï¼ˆBaselineï¼‰ï¼š
for batch in dataloader:
    images, labels = batch  # labels âˆˆ [0, 45]åº¦
    train_gan(images, labels)

# è¯„ä¼°æ—¶ï¼š
for angle in [0, 10, 20, ..., 80, 90]:  # â­ åŒ…æ‹¬45-90åº¦ï¼
    fake_image = gan.generate(noise, angle)
    # å³ä½¿angle=80åº¦è®­ç»ƒæ—¶æ²¡è§è¿‡
    # ç”Ÿæˆå™¨ä¹Ÿä¼šå°è¯•ç”Ÿæˆ
    # ä½†è´¨é‡ä¼šå¾ˆå·®ï¼ˆè¿™å°±æ˜¯OODé—®é¢˜ï¼‰
```

---

### **Q2: ç”Ÿæˆå™¨æ€ä¹ˆèƒ½ç”Ÿæˆæ²¡è§è¿‡çš„è§’åº¦ï¼Ÿ**

**A**: é€šè¿‡**æ¡ä»¶åµŒå…¥å’Œæ¡ä»¶BatchNorm**

```python
# ç”Ÿæˆå™¨å†…éƒ¨ï¼ˆmodels/sngan.pyï¼‰
class Generator(nn.Module):
    def forward(self, z, labels):
        # labelsç»è¿‡embeddingå˜æˆå‘é‡
        y = label_embedding(labels)  # [batch, 128]
        
        # æ¯ä¸€å±‚éƒ½ç”¨labelsä½œä¸ºæ¡ä»¶
        out = self.block1(out, y)  # ConditionalBatchNorm
        out = self.block2(out, y)
        ...
        
# å…³é”®ç‚¹ï¼š
# 1. labelså¯ä»¥æ˜¯ä»»æ„å€¼ï¼ˆæ¯”å¦‚80åº¦ï¼‰
# 2. ç½‘ç»œä¼šæ ¹æ®å­¦åˆ°çš„"è§„å¾‹"å°è¯•ç”Ÿæˆ
# 3. ä½†å¦‚æœè®­ç»ƒæ—¶æ²¡è§è¿‡ï¼Œä¼šé "å¤–æ¨"â†’ å®¹æ˜“å¤±è´¥
```

**ç±»æ¯”ç†è§£**ï¼š
```
è®­ç»ƒï¼šçœ‹äº†0-45åº¦çš„æ¤…å­æ—‹è½¬å›¾
     â”œâ”€ å­¦ä¼šäº†ï¼šè§’åº¦â†‘ â†’ æ¤…å­çœ‹èµ·æ¥æ›´ä¾§é¢
     â””â”€ å­¦ä¼šäº†ï¼šæ—‹è½¬å˜åŒ–çš„"è¶‹åŠ¿"

æµ‹è¯•ï¼šè¾“å…¥80åº¦
     â”œâ”€ ç½‘ç»œå°è¯•å¤–æ¨ï¼š80åº¦åº”è¯¥æ›´ä¾§é¢
     â”œâ”€ ä½†æ²¡è§è¿‡ï¼Œç»†èŠ‚ä¼šå‡ºé”™
     â””â”€ ç»“æœï¼šå¤§è‡´æ–¹å‘å¯¹ï¼Œä½†è´¨é‡å·®
```

---

### **Q3: è¯„ä¼°æµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ**

**A**: ä¸¤ç§æ–¹å¼

#### **æ–¹å¼1ï¼šè®­ç»ƒ+è¯„ä¼°ä¸€èµ·ï¼ˆæ¨èï¼‰**

```bash
# è®­ç»ƒè„šæœ¬ä¸­æ·»åŠ  --do_eval
python main.py \
    --setting_name baseline_id_only \
    --min_label 0 \
    --max_label 45 \  # è®­ç»ƒï¼šåªç”¨0-45åº¦
    --niters 30000 \
    --do_eval \        # â­ è®­ç»ƒåè‡ªåŠ¨è¯„ä¼°
    ...

# main.pyå†…éƒ¨æµç¨‹ï¼š
# 1. è®­ç»ƒï¼ˆç¬¬249-254è¡Œï¼‰
trainer.train()  # åªç”¨0-45åº¦æ•°æ®

# 2. è¯„ä¼°ï¼ˆç¬¬267-314è¡Œï¼‰
evaluator = Evaluator(...)
# â­ å…³é”®ï¼ševaluatorä¼šåœ¨å…¨èŒƒå›´ç”Ÿæˆï¼
for angle in eval_labels:  # åŒ…æ‹¬0-90åº¦ï¼
    fake_images = generator.sample(angle)
    compute_metrics(fake_images)
```

#### **æ–¹å¼2ï¼šç‹¬ç«‹è¯„ä¼°ï¼ˆçµæ´»ï¼‰**

```bash
# ä½¿ç”¨step6_evaluate_ood.sh
bash experiments/step6_evaluate_ood.sh

# ç‰¹ç‚¹ï¼š
# - å¯ä»¥é‡å¤è¯„ä¼°
# - å¯ä»¥æ”¹å˜è¯„ä¼°èŒƒå›´
# - ä¸éœ€è¦é‡æ–°è®­ç»ƒ
```

---

## ğŸ“Š **è¯„ä¼°æŒ‡æ ‡è¯´æ˜**

### **1. Label Score (LS)**

**å«ä¹‰**ï¼šç”Ÿæˆå›¾åƒä¸ç›®æ ‡æ ‡ç­¾çš„ä¸€è‡´æ€§

```python
# ä½¿ç”¨é¢„è®­ç»ƒçš„ResNet34å›å½’æ¨¡å‹
for angle in eval_angles:
    fake_image = generator(noise, angle)
    pred_angle = resnet34_regressor(fake_image)
    ls = |pred_angle - angle|  # MAE

# æœŸæœ›ï¼š
# - IDåŒºåŸŸï¼ˆ0-45åº¦ï¼‰: LS â‰ˆ 3-5åº¦ âœ…
# - OODåŒºåŸŸï¼ˆ45-90åº¦ï¼‰: 
#   * Baseline: LS â‰ˆ 20-30åº¦ âŒ
#   * Simple-Mix: LS â‰ˆ 10-15åº¦ âš ï¸
#   * Oracle: LS â‰ˆ 3-5åº¦ âœ…
```

### **2. FID (FrÃ©chet Inception Distance)**

**å«ä¹‰**ï¼šç”Ÿæˆå›¾åƒä¸çœŸå®å›¾åƒçš„åˆ†å¸ƒè·ç¦»

```python
# è¶Šå°è¶Šå¥½
# - Baselineåœ¨OOD: FIDé«˜ï¼ˆè´¨é‡å·®ï¼‰
# - Oracleå…¨èŒƒå›´: FIDä½ï¼ˆè´¨é‡å¥½ï¼‰
```

### **3. Diversity**

**å«ä¹‰**ï¼šç”Ÿæˆå›¾åƒçš„å¤šæ ·æ€§

```python
# é˜²æ­¢mode collapse
# ç¡®ä¿æ¯ä¸ªè§’åº¦éƒ½èƒ½ç”Ÿæˆå¤šæ ·çš„å›¾åƒ
```

---

## ğŸ”§ **å®Œæ•´è¯„ä¼°æµç¨‹**

### **æµç¨‹å›¾**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤1: è®­ç»ƒæ¨¡å‹ï¼ˆ0-45åº¦ï¼‰               â”‚
â”‚  â””â”€ step3_baseline_id_only.sh          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤2: è¯„ä¼°ï¼ˆ0-90åº¦å…¨èŒƒå›´ï¼‰             â”‚
â”‚  â”œâ”€ æ–¹å¼A: è®­ç»ƒæ—¶è‡ªåŠ¨è¯„ä¼°ï¼ˆ--do_evalï¼‰    â”‚
â”‚  â””â”€ æ–¹å¼B: ç‹¬ç«‹è¯„ä¼°ï¼ˆstep6ï¼‰             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤3: ç”Ÿæˆfake_data/                   â”‚
â”‚  â”œâ”€ å¯¹æ¯ä¸ªè§’åº¦ç”Ÿæˆ200å¼ å›¾åƒ              â”‚
â”‚  â”œâ”€ ä¿å­˜ä¸ºh5æ ¼å¼                         â”‚
â”‚  â””â”€ ç”¨äºè®¡ç®—è¯„ä¼°æŒ‡æ ‡                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤4: è®¡ç®—è¯„ä¼°æŒ‡æ ‡                     â”‚
â”‚  â”œâ”€ Label Scoreï¼ˆè§’åº¦å‡†ç¡®æ€§ï¼‰            â”‚
â”‚  â”œâ”€ FIDï¼ˆå›¾åƒè´¨é‡ï¼‰                      â”‚
â”‚  â””â”€ Diversityï¼ˆå¤šæ ·æ€§ï¼‰                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ­¥éª¤5: åˆ†æç»“æœ                         â”‚
â”‚  â”œâ”€ å¯¹æ¯”ID vs OODæ€§èƒ½                    â”‚
â”‚  â”œâ”€ å¯¹æ¯”Baseline vs Simple-Mix          â”‚
â”‚  â””â”€ ä¸Oracleæ¯”è¾ƒå·®è·                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ **è¯„ä¼°å‘½ä»¤è¯¦è§£**

### **è®­ç»ƒæ—¶è‡ªåŠ¨è¯„ä¼°**

```bash
# step3_baseline_id_only.sh å·²åŒ…å«
python main.py \
    --setting_name baseline_id_only \
    --min_label 0 \
    --max_label 45 \      # â­ è®­ç»ƒï¼š0-45åº¦
    --niters 30000 \
    --do_eval \           # â­ è¯„ä¼°ï¼šå…¨èŒƒå›´ï¼ˆç”±evaluatorå†³å®šï¼‰
    --samp_batch_size 200 \
    --eval_batch_size 200 \
    ...
```

**å…³é”®ç‚¹**ï¼š
- `--min_label 0 --max_label 45`: æ§åˆ¶**è®­ç»ƒ**æ•°æ®èŒƒå›´
- `--do_eval`: è§¦å‘è¯„ä¼°ï¼Œè¯„ä¼°èŒƒå›´ç”±`eval_labels`å†³å®š
- `eval_labels`åœ¨`dataset.py`ä¸­å®šä¹‰ï¼Œé€šå¸¸æ˜¯å…¨èŒƒå›´

---

### **ç‹¬ç«‹è¯„ä¼°ï¼ˆå·²è®­ç»ƒæ¨¡å‹ï¼‰**

```bash
# ä¿®æ”¹step6_evaluate_ood.shä¸­çš„EXPERIMENT
EXPERIMENT="baseline_id_only"  # é€‰æ‹©è¦è¯„ä¼°çš„æ¨¡å‹
RESUME_ITER=30000              # ä½¿ç”¨æœ€åçš„checkpoint

bash experiments/step6_evaluate_ood.sh
```

---

## ğŸ¯ **å®éªŒå¯¹æ¯”è¡¨**

| å®éªŒ | è®­ç»ƒèŒƒå›´ | è¯„ä¼°èŒƒå›´ | IDæ€§èƒ½ | OODæ€§èƒ½ | ç›®çš„ |
|------|---------|---------|--------|---------|------|
| **Baseline** | 0-45Â° | 0-90Â° | â­â­â­â­â­ | â­ | è¯æ˜é—®é¢˜å­˜åœ¨ |
| **Simple-Mix** | 0-45Â°å…¨+45-90Â°å°‘ | 0-90Â° | â­â­â­â­â­ | â­â­ | ç®€å•æ–¹æ³•ä¸å¤Ÿ |
| **Oracle** | 0-90Â° | 0-90Â° | â­â­â­â­â­ | â­â­â­â­â­ | æ€§èƒ½ä¸Šç•Œ |

---

## ğŸ“ˆ **é¢„æœŸè¯„ä¼°ç»“æœ**

### **Label Score (MAE)**

```
è§’åº¦èŒƒå›´    | Baseline | Simple-Mix | Oracle
-----------|----------|------------|--------
0-15Â°      | 3.2      | 3.1        | 3.0
15-30Â°     | 4.1      | 4.0        | 3.8
30-45Â°     | 5.3      | 5.1        | 4.2
45-60Â°     | 18.7     | 11.2       | 4.5  â­ OODå¼€å§‹
60-75Â°     | 25.3     | 14.8       | 5.1
75-90Â°     | 28.9     | 16.3       | 5.3
```

**ç»“è®º**ï¼š
- Baselineåœ¨OODåŒºåŸŸæ€§èƒ½æ€¥å‰§ä¸‹é™
- Simple-Mixæœ‰æ”¹å–„ä½†ä¸å¤Ÿï¼ˆåªè¾¾åˆ°Oracleçš„60-70%ï¼‰
- éœ€è¦æ›´sophisticatedçš„æ–¹æ³•

---

## ğŸ› ï¸ **å¸¸è§é—®é¢˜**

### **Q: ä¸ºä»€ä¹ˆè®­ç»ƒæ—¶ç”¨0-45åº¦ï¼Œè¯„ä¼°å´ç”¨0-90åº¦ï¼Ÿ**
**A**: 
- **è®­ç»ƒèŒƒå›´**ï¼šå†³å®šæ¨¡å‹è§è¿‡å“ªäº›æ•°æ®
- **è¯„ä¼°èŒƒå›´**ï¼šéªŒè¯æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›
- **ç›®çš„**ï¼šæµ‹è¯•OODæ³›åŒ–æ€§èƒ½

### **Q: è¯„ä¼°æ—¶fake_data/ç›®å½•çš„æ•°æ®æ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿ**
**A**:
```python
# evaluator.py
def dump_h5_files(self, output_path):
    for label in eval_labels:  # 0-90åº¦å…¨èŒƒå›´
        for i in range(200):   # æ¯ä¸ªè§’åº¦ç”Ÿæˆ200å¼ 
            z = random_noise()
            fake = generator(z, label)  # â­ ç”Ÿæˆï¼
            save_fake(fake)
```

### **Q: ç”ŸæˆOODåŒºåŸŸçš„å›¾åƒéœ€è¦OODè®­ç»ƒæ•°æ®å—ï¼Ÿ**
**A**: 
- âŒ **ä¸éœ€è¦**è®­ç»ƒæ•°æ®
- âœ… **éœ€è¦**è®­ç»ƒå¥½çš„ç”Ÿæˆå™¨
- ğŸ¯ ç”Ÿæˆå™¨å¯ä»¥æ¥å—ä»»æ„æ¡ä»¶è¾“å…¥

---

## ğŸ“‹ **å¿«é€Ÿæ£€æŸ¥æ¸…å•**

### **è®­ç»ƒå®Œæˆå**
- âœ… `ckpt_niter_30000.pth` å­˜åœ¨
- âœ… `imgs_in_train/30000.png` å­˜åœ¨
- âœ… å¦‚æœåŠ äº†`--do_eval`ï¼Œ`fake_data/`åº”è¯¥æœ‰æ•°æ®

### **è¯„ä¼°ç»“æœä½ç½®**
```bash
output/RC-49_64/baseline_id_only/
â”œâ”€â”€ results/
â”‚   â”œâ”€â”€ fake_data/          # ç”Ÿæˆçš„è¯„ä¼°æ ·æœ¬
â”‚   â”‚   â””â”€â”€ h5/            # æ¯ä¸ªè§’åº¦200å¼ 
â”‚   â””â”€â”€ ...
â””â”€â”€ eval_<timestamp>/       # è¯„ä¼°æŒ‡æ ‡
    â”œâ”€â”€ eval_results.txt   # â­ ä¸»è¦ç»“æœ
    â””â”€â”€ ...
```

---

## ğŸš€ **æ¨èå·¥ä½œæµç¨‹**

```bash
# 1. è®­ç»ƒBaselineï¼ˆå·²åŒ…å«è¯„ä¼°ï¼‰
bash experiments/step3_baseline_id_only.sh

# 2. è®­ç»ƒSimple-Mixï¼ˆå·²åŒ…å«è¯„ä¼°ï¼‰
bash experiments/step4_simple_mix.sh

# 3. è®­ç»ƒOracleï¼ˆå·²åŒ…å«è¯„ä¼°ï¼‰
bash experiments/step5_oracle_full.sh

# 4. å¯¹æ¯”ç»“æœ
cat output/RC-49_64/baseline_id_only/eval_*/eval_results.txt
cat output/RC-49_64/simple_mix_50/eval_*/eval_results.txt
cat output/RC-49_64/oracle_full/eval_*/eval_results.txt

# 5. å¯é€‰ï¼šé‡æ–°è¯„ä¼°
# ä¿®æ”¹step6_evaluate_ood.shä¸­çš„EXPERIMENTå˜é‡
bash experiments/step6_evaluate_ood.sh
```

---

## ğŸ’¡ **æ ¸å¿ƒç†è§£**

```
æ¡ä»¶ç”Ÿæˆæ¨¡å‹ = å‡½æ•° f(noise, condition)
                       â†‘         â†‘
                    éšæœºæ€§    å¯æ§åˆ¶

è®­ç»ƒï¼š
  - è§è¿‡ï¼šcondition âˆˆ [0, 45]åº¦
  - å­¦ä¼šï¼šè§’åº¦ â†’ å›¾åƒçš„æ˜ å°„

æµ‹è¯•ï¼š
  - è¾“å…¥ï¼šcondition = 80åº¦ï¼ˆæ²¡è§è¿‡ï¼‰
  - è¡Œä¸ºï¼šå°è¯•å¤–æ¨ï¼Œç”Ÿæˆ"80åº¦"çš„æ ·å­
  - ç»“æœï¼šæ–¹å‘å¤§è‡´å¯¹ï¼Œä½†ç»†èŠ‚å·®ï¼ˆOODé—®é¢˜ï¼‰

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆï¼š
  âœ… å¯ä»¥ç”ŸæˆOODåŒºåŸŸçš„å›¾åƒ
  âŒ ä½†è´¨é‡å¾ˆå·®
  ğŸ¯ éœ€è¦ç ”ç©¶å¦‚ä½•æ”¹å–„OODæ³›åŒ–
```

---

**ç°åœ¨ä½ åº”è¯¥å®Œå…¨ç†è§£æ•´ä¸ªè¯„ä¼°æµç¨‹äº†ï¼** ğŸ‰

æœ‰ä»»ä½•ç–‘é—®éšæ—¶é—®æˆ‘ï¼

